---
title: "COASTLOOC data paper"
date: "Last compiled on `r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    highlight: zenburn
    css: "theme.css"
    toc: true
    toc_float:
      collapsed: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.pos = "center",
  cache = TRUE
)

library(here)
library(tidyverse)
library(kableExtra)

library(ggpmthemes)

# Set default ggplot2 font size and font family
# devtools::install_github("PMassicotte/ggpmthemes")
theme_set(theme_light_modified(
  base_family = "Montserrat Alternates",
  base_size = 10
))

theme_update(
  panel.border = element_blank(),
  axis.ticks = element_blank(),
  strip.background = element_blank(),
  strip.text = element_text(face = "bold", size = 10, color = "#4c4a4a")
)

source(here("R/zzz.R"))
```

## Data cleaning and pre-processing

This section shows the main steps that have been applied to pre-process the raw data.

### aCDOM spectra

- The CDOM spectra were modeled according to the information in Babin 2003.

  - `acdom` spectra were re-fitted using the complete data (i.e. between 350-500 nm) because the data in `all_abs_transpose.txt` started at 380 nm.

- Average background values calculated between 683-687 nm and subtracted from each spectra.

- Some files were in binary format, so I could not open them (ex.: `C2001000.YSA`).

- Some spectra start at 300 nm while others at 350 nm.

- Calculated the correlation between the measured and the fitted values.

  - Fits with R2 than 0.95 were removed from the data.

- Absorption spectra with any negative values below 500 nm were removed.

- Exported the complete spectra (350-700 nm): both the raw and the modeled data.

### Phytoplankton and non-algal absorption

- Absorption spectra with any negative values below 500 nm were removed.

### Irradiance

- There were negative values in the irradiance data (`Ed`, `Eu`, `Kd`, `Ku`). I have cleaned the data by setting these negative values to `NA`.

This graph shows the number of negative values for Ed by wavelength.

```{r histo_negative_ed}
irradiance <- read_csv(here("data/clean/irradiance.csv")) %>% 
  filter(ed < 0)

irradiance %>% 
  ggplot(aes(x = ed)) +
  geom_histogram() +
  facet_wrap(~glue::glue("{wavelength} nm"), scales = "free")
```

- Example of a spectral profile with negative value.

```{r lineplot_negative_ed}
read_csv("data/clean/irradiance.csv") %>% 
  filter(station == "C2008000") %>% 
  ggplot(aes(x = wavelength, y = ed)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Station C2008000",
    x = "Wavelength (nm)",
    y = parse(text = "E[d](0^'-')~'['~W~m^{-2}~nm^{-1}~']'")
  )

```

- `Eu` is in fact `Eu0-` that was estimated estimated using a two-exponential function model.

- `Ed` is in fact `Ed0-` calculated from `0.94 x ed0+`.

### Reflectance

- Reflectance values outside the 0-1 range were set to `NA`.

### AC9

- Negative values in `a`, `c`, `bp`, `a_dissolved` and `c_dissolved` have been set to `NA`.

- `a(715)` was used as baseline, that is why the values are always at 0 (see next graph).

```{r}
knitr::include_graphics(pdf2png(here("graphs/09_histogram_ac9_negative_values_removed.pdf")))
```

### Other stuff

- Extracted extra variables (`DOC`, `AQY`) from Massimo 2000.

## Visualizations

Just some graphs to visualize the data. *Note that the same color palette will be used to represent the areas in all graphics.*

### Temporal sampling

- This graph shows when the sampling were performed in the different areas. For instance, we can see that a large fraction of the measurements were made in September of 1998.

```{r}
source(here("R/zzz.R"))

df <- read_csv(here("data/clean/stations.csv")) %>% 
  mutate(month = clock::date_group(date, "month")) %>% 
  count(area, month) 

df %>% 
  ggplot(aes(x = n, y = factor(month), fill = area)) +
  geom_col() +
  scale_fill_manual(
    breaks = area_breaks,
    values = area_colors
  ) +
  labs(
    x = "Number of observations",
    y = NULL,
    title = "Number of measurements by month"
  ) +
  theme(
    legend.position = "top",
    legend.title = element_blank()
  )
```


### Geographical map

There is a total of 424 different stations that were sampled during the COASTLOOC expeditions.

- Note that there are two stations without geographical coordinates: `C2001000`, `C2002000`.

```{r}
knitr::include_graphics(pdf2png(here("graphs/02_geographic_map.pdf")))
```

### Available variables

This graph shows an overview of the available variables (excluding radiometric measurements).

```{r}
knitr::include_graphics(pdf2png(here("graphs/06_number_observation_nutrient_by_area.pdf")))
```

### Absorption measurements

Overview of the averaged absorption spectra for each area.

```{r}
knitr::include_graphics(pdf2png(here("graphs/11_average_absorption_spectra_by_area.pdf")))
```

Comparing `acdom443` for the different areas shows that there is a clear open to coastal gradient.

```{r}
knitr::include_graphics(pdf2png(here("graphs/13_boxplot_acdom443_by_area.pdf")))
```

We can see that the `DOC` follows the same pattern as `acdom443`.

```{r}
knitr::include_graphics(pdf2png(here("graphs/12_boxplot_doc_by_area.pdf")))
```

We can also use scatter-plots to further explore the relationships among variables.

```{r}
knitr::include_graphics(pdf2png(here("graphs/13_aphy_vs_anap.pdf")))
```

Relationships between some pigments.

```{r}
knitr::include_graphics(pdf2png(here("graphs/nano_chla_vs_hexanoyloxyfucoxanthin_19.pdf")))
```

#### aphy

```{r}
knitr::include_graphics(pdf2png(here("graphs/04_aphy_spectral_profiles_by_area.pdf")))
```

We could also assess the goodness of the relationships between total chlorophyll-a and phytoplankton absorption for each region.

```{r}
knitr::include_graphics(pdf2png(here("graphs/15_total_chla_vs_aphy443.pdf")))
```

#### anap

```{r}
knitr::include_graphics(pdf2png(here("graphs/04_anap_spectral_profiles_by_area.pdf")))
```

#### atot

```{r}
knitr::include_graphics(pdf2png(here("graphs/04_atot_spectral_profiles_by_area.pdf")))
```

#### acdom

```{r}
knitr::include_graphics(pdf2png(here("graphs/04_acdom_spectral_profiles_by_area.pdf")))
```

### Irradiance

#### Ed

```{r}
knitr::include_graphics(pdf2png(here("graphs/07_ed_spectral_profiles_by_area.pdf")))
```

#### Eu

```{r}
knitr::include_graphics(pdf2png(here("graphs/07_eu_spectral_profiles_by_area.pdf")))
```

#### Kd

```{r}
knitr::include_graphics(pdf2png(here("graphs/07_kd_spectral_profiles_by_area.pdf")))
```

#### Ku

```{r}
knitr::include_graphics(pdf2png(here("graphs/07_ku_spectral_profiles_by_area.pdf")))
```

### Reflectance

```{r}
knitr::include_graphics(pdf2png(here("graphs/08_reflectance_profiles_by_area.pdf")))
```

### AC9

#### Absorption

```{r}
knitr::include_graphics(pdf2png(here("graphs/09_ac9_a_spectral_profiles_by_area.pdf")))
```

#### Beam attenuation

```{r}
knitr::include_graphics(pdf2png(here("graphs/09_ac9_c_spectral_profiles_by_area.pdf")))
```

#### Backscattering

```{r}
knitr::include_graphics(pdf2png(here("graphs/09_ac9_bp_spectral_profiles_by_area.pdf")))
```

## Data validation and diagnostics

In this section we will explore various diagnostic graphics to validate the data.

### Absorption (AC9 and spectrofluorometer)

In theory, the dissolved absorption measured by the spectrofluorometer `aCDOM` should be comparable with the dissolved absorption measured by the `AC9` (using a filter). The next graphs compare both measurements at common wavelengths for the different areas.

```{r}
knitr::include_graphics(pdf2png(here("graphs/14_compare_spectrofluorimeter_and_ac9_absorption_scatterplot.pdf")))
```

We can also use sina plot as another way to compare the same data. 

```{r}
knitr::include_graphics(pdf2png(here("graphs/14_compare_spectrofluorimeter_and_ac9_absorption_boxplot.pdf")))
```

## Orientation of the paper

- The data is a mix of temporal and spatial observations, so how should we present the data?

- By `area`?

## TODOS

- No absorption for `Med. Sea (Case 1)`. Is it normal?

- There are a lot of nutrient parameters that have values of zero. Are they true zero or they indicate missing values?

- There are wavelength gaps in the `AC9`, `irradiance` and `reflectance` data. Is that normal?

- [x] test

