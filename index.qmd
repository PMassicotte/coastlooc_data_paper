---
title: "Coastlooc data paper"
format: 
  html:
    toc: true
    self-contained: true
    fig-format: svg
    # fig-dpi: 300
editor_options: 
  chunk_output_type: console
bibliography: /home/filoche/Documents/library.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.pos = "center",
  cache = FALSE
)

library(tidyverse)
library(here)

library(ggpmthemes)
extrafont::loadfonts()
# Set default ggplot2 font size and font family
# devtools::install_github("PMassicotte/ggpmthemes")
theme_set(theme_light_modified(
  base_family = "Poppins",
  base_size = 10
))

theme_update(
  panel.border = element_blank(),
  axis.ticks = element_blank(),
  strip.background = element_blank(),
  strip.text = element_text(face = "bold", size = 10, color = "#4c4a4a")
)

source(here("R", "zzz.R"))
```

## Data cleaning and pre-processing

This section shows the main steps that have been applied to pre-process the raw data.

### aCDOM spectra

- The CDOM spectra were modelled according to the information in @.

    - `acdom` spectra were re-fitted using the complete data (i.e. between 350-500 nm) because the data in `all_abs_transpose.txt` started at 380 nm.

- Average background values calculated between 683-687 nm and subtracted from each spectrum.

- Some files were in binary format, so I could not open them (ex.: `C2001000.YSA`).

- Some spectra start at 300 nm while others at 350 nm.

- Calculated the correlation between the measured and the fitted values.

    - Fits with R2 lower than 0.95 were removed from the data.

- Absorption spectra with any negative values below 500 nm were removed.

- Exported the complete spectra (350-700 nm): both the raw and the modelled data.

### Phytoplankton and non-algal absorption

- Absorption spectra with any negative values below 500 nm were removed.

### Irradiance

- There were negative values in the irradiance data (`Ed`, `Eu`, `Kd`, `Ku`). I have cleaned the data by setting these negative values to `NA`.

- `Eu` is in fact `Eu0-` that was estimated using a two-exponential function model.

- `Ed` is in fact `Ed0-` calculated from `0.94 x ed0+`.

- There are differences in wavelengths among cruises. I have not found any information in the report concerning channel change across the missions.

```{r}
irradiance <- read_csv("data/clean/irradiance.csv")

irradiance |> 
  mutate(cruise = str_sub(station, 1, 2), .after = station) |> 
  distinct(cruise, wavelength) |> 
  group_nest(cruise) |> 
  unnest_wider(data) |> 
  pivot_wider(names_from = cruise, values_from = wavelength) |> 
  unnest(everything()) |> 
  knitr::kable() |> 
  kableExtra::kable_styling()

irradiance |> 
  mutate(cruise = str_sub(station, 1, 2), .after = station) |> 
  distinct(cruise, wavelength) |> 
  group_nest(cruise) |> 
  unnest_wider(data) |> 
  pivot_wider(names_from = cruise, values_from = wavelength) |> 
  unnest(everything()) |> 
  rowwise() |> 
  mutate(u = length(unique(c_across(everything())))) |> 
  filter(u != 1) |> 
  select(-u) |> 
  knitr::kable() |> 
  kableExtra::kable_styling()
```

### Reflectance

- Reflectance values outside the 0-1 range were set to `NA`.

### Other stuff

- Extracted extra variables (`DOC`, `AQY`) from Massimo 2000.

### Bathymetry

- I have extracted the bathymetry at each sampling locations.

## Journal candidates

- [Scientific data](https://www.nature.com/sdata/) (I.F: 5.541)
- [Earth System Science Data (ESSD)](https://earth-system-science-data.net/) (I.F: 9.197)
- [PLOS One](https://journals.plos.org/plosone/) (I.F: 2.740)

## Figures for the paper

This section shows the figures that I think should be included in the data paper.

### Figure 1

Figure 1: Map of the sampling stations. Red outlines in the bottom panels (Mediterranean Sea and North Sea) identify the stations used to present examples of subsurface reflectance spectra in Fig. 9.

```{r fig01}
knitr::include_graphics(pdf2png(here("graphs", "fig01.pdf")))
```

### Figure 2

Figure 2: (**A**) Overview of the temporal sampling for the seven areas. The numbers in the circles indicate the number of visited stations each month. (**B**) Boxplot showing the bathymetry at the sampling locations by area.

```{r fig02}
knitr::include_graphics(pdf2png(here("graphs", "fig02.pdf")))
```
### Figure 3

Figure 3: (**A**) Total chlorophyll-a and (**B**) particulate organic carbon across the sampled areas.

```{r fig03}
knitr::include_graphics(pdf2png(here("graphs", "fig03.pdf")))
```

### Figure 4

Figure 4: (**A**) Average total particulate ($a_\text{p}$), (**B**) non-algal ($a_\text{NAP}$), (**C**) phytoplankton ($a_{\phi}$) and (**D**) chromophoric dissolved organic matter ($a_\text{CDOM}$) absorption spectra in each area. (**E**) $a_\text{CDOM}(350)$ along the westernmost transect in the North Sea (see Fig. 1B).

```{r fig04}
knitr::include_graphics(pdf2png(here("graphs", "fig04.pdf")))
```

### Figure 5

Figure 5: (**A**) Particulate scattering coefficient at 440 nm ($b_{b}(440)$) and (**B**) attenuation coefficient for downward irradiance at 443 nm ($K_{d}(443)$) across the sampled areas.

```{r fig05}
knitr::include_graphics(pdf2png(here("graphs", "fig05.pdf")))
```

### Figure 6

Figure 6: Subsurface reflectance R(0-) across the sampled areas. The thick lines represent the regional averages. Note that R(0-) at wavelengths above 705 nm could only be derived from helicopter-based measurements.

```{r fig06}
knitr::include_graphics(pdf2png(here("graphs", "fig06.pdf")))
```

### Figure 7

Scatterplots showing relationships among different selected variables. (**A**) Particulate organic carbon (POC) and (**B**) phytoplankton absorption at 443 nm ($a_{\phi}(443)$) against total chlorophyll-a. (**C**) Downward irradiance at 443 nm ($E_{d}(443)$) and (**D**) particulate scattering at 440 nm ($b_{b}(440)$ against particulate organic carbon. The red lines show the linear relationships between the variables. The shaded gray areas represent the 95% confidence intervals around the fitted models.

```{r fig07}
knitr::include_graphics(pdf2png(here("graphs", "fig07.pdf")))
```

### Figure 8

(**A**) Vertical profile of the upwelling irradiance at station C1021, located in the North-East Atlantic offshore Northern Portugal. A double deep chlorophyll maximum with the corresponding irradiance increase due to chlorophyll fluorescence is observed at ca. 35 m and 45 m water depth, respectively, most prominently at 683 nm, but als at 664 nm and even at 706 nm. (**B**) Vertical profiles of the upwelling and downwelling irradiance at station C6176, located in the Baltic Sea offshore Usedom Island in North-East Germany. Baltic Sea waters are rich in CDOM, resulting in strong absorption in the UV and blue. The reduced decrease of the upwelling irradiance at 559 nm towards larger depths is likely caused by reflection from the ocean bottom.

```{r fig08a}
knitr::include_graphics(here("graphs", "fig08a.png"))
```

```{r fig08b}
knitr::include_graphics(here("graphs", "fig08b.png"))
```

### Figure 9

(**A**) Kd(490) profiles along a transect taken in the Lion’s Gulf on 30. Sept. 1997 from site C4014 located ca. 5 km to the west of the mouth of the main Rhône branch (Grand Rhône) to site C4019 some 20 km further south in clear Mediterranean waters. (**B**) Kd(490) profiles along a transect taken in the North Sea on 12. Sept. 1998 extending from site C6063 close to the western shore of the island of Texel to site C6069 located ca. 22 km further west in the open North Sea.

```{r fig09a}
knitr::include_graphics(here("graphs", "fig09a.png"))
```

```{r fig09b}
knitr::include_graphics(here("graphs", "fig09b.png"))
```

### Appendix 1

Example of extrapolation of the upward irradiance towards the sea surface. The irradiance values just below the sea surface and the corresponding diffuse attenuation coefficient for the topmost water layer are specified in the figures.

```{r appendix01}
knitr::include_graphics(pdf2png(here("graphs", "appendix01.pdf")))
```

## Done

- [x] Validated that there are no absorption for Med. Sea Case 1 cruise.

- [x] A few stations were located on the land (bad geographical coordinates). They have been removed.

- [x] Calculate `s_nap` and `s_cdom`. See the method in @babin2003 where he removes some wavelengths to calculate `s_nap`.

- [x] Removed dissolved `a` and `c` from the AC9 data because there were problems with the filtering procedure during the sampling. These correspond to the `ad` and `cd` variables in `SurfaceData5(C4corr).txt`.

- [x] Extract bathymetry at each station.

- [x] Zoom on geographic areas in Fig. 1 such as figure 13 in the final report.

- [x] Recode Ed wavelengths from the SPMR *vertical* profiles as:

    - 412 -\> 411
    - 510 -\> 509
    - 589 -\> 590
    - 666 -\> 665
    - 780 -\> 779

- [x] Validated that are only two AC9 measurements in the Adriatic Sea.

- [x] Removed duplicated radiometric surface spectral profiles (duplicated Ed/Eu/Kd/Ku).

- [x] Removed Almofront (A2, Med case 1) observations as they were collected from a separate mission with different funding.

## TODO

- Use `piggyback` <https://docs.ropensci.org/piggyback/>

## References
